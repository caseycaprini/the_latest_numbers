"0",""
"0","# Function that calculates WP movement stats for a data.frame containing a single game"
"0","# Function expects data.frame with home WP (home_p) and its complement (home_q) each observation"
"0","wp_movement_nfl <- function(df){"
"0","  for(i in 1:nrow(df)){"
"0","    # No movement in WP for first row, so stays NA"
"0","    if(i == 1){"
"0","      df$unc_reduction[i] = NA_real_"
"0","      df$movement[i] = NA_real_"
"0","    }"
"0","    else {"
"0","      df$unc_reduction[i] = (df$home_p[i - 1]*df$home_q[i - 1]) - (df$home_p[i]*df$home_q[i])"
"0","      df$movement[i] = (df$home_p[i] - df$home_p[i-1])^2"
"0","    }"
"0","  }"
"0","  "
"0","  return(df)"
"0","}"
"0",""
"0","raw_nfl_df <- load_pbp(2021)"
"1","Note: nflreadr caches (i.e., stores a saved version) data by default.
If you expect different output try one of the following:
[34mi[39m Restart your R Session or
[34mi[39m Run `nflreadr::.clear_cache()`.
To disable this warning, run `options(nflreadr.verbose = FALSE)` or add it to your .Rprofile
[90mThis message is displayed once every 8 hours.[39m
"
"0","# Find games with plays in OT"
"0","ot_games <- raw_nfl_df %>%"
"0","  group_by(game_id, game_half) %>%"
"0","  summarize(n = n()) %>%"
"0","  filter(game_half == ""Overtime"") %>%"
"0","  ungroup() %>%"
"0","  pull(game_id)"
"1","[38;5;232m`summarise()` has grouped output by 'game_id'. You can override using the `.groups` argument.[39m
"
"0","nfl_df <- raw_nfl_df %>%"
"0","  # Remove games that went to OT"
"0","  filter((game_id %in% ot_games) == F) %>%"
"0","  # Create p and q variables that are more intuitive to me"
"0","  rename(home_p = vegas_home_wp) %>%"
"0","  mutate(home_q = 1 - home_p) %>%"
"0","  select(game_id, home_p, home_q) %>%"
"0","  # Add variable to calculate movement and uncertainty reduction"
"0","  mutate(movement = NA_real_,"
"0","         unc_reduction = NA_real_)"
"0",""
"0","# Nest season by game"
"0","# Apply WP movement function to each game"
"0","# Unnest back to long data.frame"
"0","nfl_season_df <- nfl_df %>%"
"0","  group_nest(game_id) %>%"
"0","  mutate(movement_df = map(data, wp_movement_nfl)) %>%"
"0","  select(game_id, movement_df) %>%"
"0","  unnest(cols = movement_df)"
"0",""
