"0","mod_rand_int <- lme4::lmer(yards_gained ~ 1 + (1|posteam) + (1|defteam),
                           data = pbp_df)

off_avg <- pbp_df %>%
  group_by(posteam) %>%
  summarize(off_yards_per_snap = mean(yards_gained)) %>%
  rename(team = posteam)

off_rand_int <- coef(mod_rand_int)$posteam %>%
  rownames_to_column(var = ""team"") %>%
  rename(off_adj_yards_per_snap = `(Intercept)`)

def_avg <- pbp_df %>%
  group_by(defteam) %>%
  summarize(def_yards_per_snap = mean(yards_gained)) %>%
  rename(team = defteam)

def_rand_int <- coef(mod_rand_int)$defteam %>%
  rownames_to_column(var = ""team"") %>%
  rename(def_adj_yards_per_snap = `(Intercept)`)



per_snap_df <- off_avg %>%
  left_join(off_rand_int,
            by = ""team"") %>%
  left_join(def_avg,
            by = ""team"") %>%
  left_join(def_rand_int,
            by = ""team"")


mean_def_adj_per_snap <- mean(per_snap_df$def_adj_yards_per_snap)
mean_off_adj_per_snap <- mean(per_snap_df$off_adj_yards_per_snap)

off_post_strat <- pbp_df %>%
  group_by(week, posteam, defteam) %>%
  summarize(n = n()) %>%
  rename(team = posteam) %>%
  left_join(per_snap_df %>%
              select(team, def_adj_yards_per_snap),
            by = c(""defteam"" = ""team"")) %>%
  ungroup() %>%
  group_by(team) %>%
  summarize(off_opp_adj = mean_def_adj_per_snap / weighted.mean(def_adj_yards_per_snap, n))
"
"1","[38;5;232m`summarise()` has grouped output by 'week', 'posteam'. You can override using the `.groups` argument.[39m
"
"0",""
"0","def_post_strat <- pbp_df %>%"
"0","  group_by(week, defteam, posteam) %>%"
"0","  summarize(n = n()) %>%"
"0","  rename(team = defteam) %>%"
"0","  left_join(per_snap_df %>%"
"0","              select(team, off_adj_yards_per_snap),"
"0","            by = c(""posteam"" = ""team"")) %>%"
"0","  ungroup() %>%"
"0","  group_by(team) %>%"
"0","  summarize(def_opp_adj = mean_off_adj_per_snap / weighted.mean(off_adj_yards_per_snap, n))"
"1","[38;5;232m`summarise()` has grouped output by 'week', 'defteam'. You can override using the `.groups` argument.[39m
"
"0","per_snap_df <- per_snap_df %>%"
"0","  left_join(def_post_strat,"
"0","            by = ""team"") %>%"
"0","  left_join(off_post_strat,"
"0","            by = ""team"") %>%"
"0","  mutate(off_adj_yards_per_snap = off_adj_yards_per_snap * off_opp_adj,"
"0","         def_adj_yards_per_snap = def_adj_yards_per_snap * def_opp_adj,"
"0","         off_opp_adj = NULL,"
"0","         def_opp_adj = NULL)"
"0",""
"0","df <- teams_colors_logos %>%"
"0","  select(team_logo_espn,"
"0","         team_abbr) %>%"
"0","  rename(team = team_abbr) %>%"
"0","  left_join(time_avg_df,"
"0","            by = ""team"") %>%"
"0","  # Removes old team names present in teams_colors_logos data.frame"
"0","  filter(is.na(time_avg_lead) == F) %>%"
"0","  left_join(per_snap_df,"
"0","            by = ""team"") %>%"
"0","  mutate(yards_per_snap_diff = off_yards_per_snap - def_yards_per_snap,"
"0","         adj_yards_per_snap_diff = off_adj_yards_per_snap - def_adj_yards_per_snap) %>%"
"0","  mutate(adj_per_snap_std = scale(adj_yards_per_snap_diff)) %>%"
"0","  mutate(adj_per_snap_percentile = pnorm(adj_per_snap_std))"
